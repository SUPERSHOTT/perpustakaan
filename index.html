<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perpustakaan (Full Implementation)</title>
    <style>
        /* CSS Styling - Clean Dashboard Look */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f6f7;
            --text: #333;
            --sidebar-width: 260px;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { margin-bottom: 30px; font-size: 1.4rem; border-bottom: 1px solid #ffffff30; padding-bottom: 10px; }
        .nav-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--accent); }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card h3 { font-size: 2rem; color: var(--accent); margin-bottom: 5px; }
        .card p { color: #7f8c8d; font-size: 0.9rem; }

        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: var(--primary); }
        
        .form-box { background: white; padding: 25px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid var(--accent); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--accent); }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        
        /* Badges for Status */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: white; display: inline-block; }
        .bg-success { background: #2ecc71; }
        .bg-warning { background: #f1c40f; color: #333; }
        .bg-danger { background: #e74c3c; }
        .bg-dark { background: #34495e; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Perpustakaan</h2>
        <div class="nav-item active" onclick="nav('dashboard')">Dashboard & Statistik</div>
        <div class="nav-item" onclick="nav('buku')">Data Buku (Master)</div>
        <div class="nav-item" onclick="nav('transaksi')">Sirkulasi (Stored Proc)</div>
        <div class="nav-item" onclick="nav('laporan')">Laporan (Join & Case)</div>
    </div>

    <div class="main">
        
        <section id="dashboard" class="section active">
            <h1>Dashboard Eksekutif</h1>
            <p style="margin-bottom:20px; color:#666;">Implementasi Query: <code>COUNT(GROUP BY)</code> dan <code>SUM()</code></p>
            
            <div class="card-grid">
                <div class="card">
                    <h3 id="dash-total-buku">0</h3>
                    <p>Total Judul Buku</p>
                </div>
                <div class="card">
                    <h3 id="dash-total-stok">0</h3>
                    <p>Total Sisa Stok</p>
                </div>
                <div class="card">
                    <h3 id="dash-total-denda">Rp 0</h3>
                    <p>Potensi Pendapatan Denda (SUM)</p>
                </div>
            </div>

            <div class="table-container">
                <h3>Statistik Koleksi per Kategori</h3>
                <p><small><i>Query: SELECT kategori, COUNT(*) FROM buku GROUP BY kategori</i></small></p>
                <table>
                    <thead>
                        <tr>
                            <th>Kategori</th>
                            <th>Jumlah Judul</th>
                            <th>Persentase</th>
                        </tr>
                    </thead>
                    <tbody id="table-aggregate">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="buku" class="section">
            <h1>Master Data Buku</h1>
            <div class="form-box">
                <h3>Tambah Buku Baru (INSERT)</h3>
                <form onsubmit="addBuku(event)">
                    <div class="form-group">
                        <label>Judul Buku</label>
                        <input type="text" id="buku-judul" class="form-control" required placeholder="Contoh: Belajar SQL Dasar">
                    </div>
                    <div style="display:flex; gap:15px;">
                        <div class="form-group" style="flex:1">
                            <label>Kategori</label>
                            <select id="buku-kategori" class="form-control">
                                <option>Teknologi</option>
                                <option>Sains</option>
                                <option>Fiksi</option>
                                <option>Sejarah</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>Stok Awal</label>
                            <input type="number" id="buku-stok" class="form-control" value="5" min="1">
                        </div>
                    </div>
                    <button class="btn btn-primary">Simpan ke Database</button>
                </form>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Judul</th>
                            <th>Kategori</th>
                            <th>Stok</th>
                        </tr>
                    </thead>
                    <tbody id="table-buku"></tbody>
                </table>
            </div>
        </section>

        <section id="transaksi" class="section">
            <h1>Sirkulasi Peminjaman</h1>
            <p style="margin-bottom:20px; color:#666;">Simulasi Logic: <code>Stored Procedure TransaksiPinjam()</code></p>

            <div class="form-box" style="border-left-color: #27ae60;">
                <h3>Form Peminjaman</h3>
                <form onsubmit="prosesStoredProcedure(event)">
                    <div class="form-group">
                        <label>Nama Peminjam (Customer)</label>
                        <select id="trx-user" class="form-control">
                            <option value="Andi Saputra">Andi Saputra</option>
                            <option value="Budi Santoso">Budi Santoso</option>
                            <option value="Citra Lestari">Citra Lestari</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pilih Buku</label>
                        <select id="trx-buku" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Pinjam</label>
                        <input type="date" id="trx-date" class="form-control">
                    </div>
                    <button class="btn btn-success">Jalankan Prosedur Peminjaman</button>
                </form>
            </div>
        </section>

        <section id="laporan" class="section">
            <h1>Laporan & Riwayat</h1>
            
            <div class="table-container">
                <h3>Riwayat Transaksi (JOIN Table)</h3>
                <p><small><i>Menampilkan gabungan data: Customer + Buku + Kategori + Status Denda</i></small></p>
                
                <table>
                    <thead>
                        <tr>
                            <th>ID Transaksi</th>
                            <th>Nama Peminjam</th>
                            <th>Buku (Kategori)</th>
                            <th>Tgl Pinjam</th>
                            <th>Tenggat</th>
                            <th>Status (CASE WHEN)</th> <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-laporan">
                        </tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        // --- 1. MOCK DATABASE (Array sebagai Tabel) ---
        let dbBuku = [
            { id: 1, judul: "Belajar SQL Dasar", kategori: "Teknologi", stok: 5 },
            { id: 2, judul: "Fisika Modern", kategori: "Sains", stok: 3 },
            { id: 3, judul: "Sejarah Dunia", kategori: "Sejarah", stok: 2 },
            { id: 4, judul: "Novel Laskar Pelangi", kategori: "Fiksi", stok: 4 }
        ];

        let dbTransaksi = []; // Tabel Peminjaman + Detail

        // --- 2. LOGIC IMPLEMENTASI QUERY ---

        // A. Fungsi Navigasi
        function nav(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
            renderAll(); // Refresh data saat pindah halaman
        }

        // B. Logic INSERT BUKU
        function addBuku(e) {
            e.preventDefault();
            const judul = document.getElementById('buku-judul').value;
            const kategori = document.getElementById('buku-kategori').value;
            const stok = parseInt(document.getElementById('buku-stok').value);

            // Simulasi INSERT INTO buku...
            dbBuku.push({
                id: dbBuku.length + 1,
                judul: judul,
                kategori: kategori,
                stok: stok
            });
            
            alert("Query INSERT Berhasil: Buku ditambahkan.");
            e.target.reset();
            renderAll();
        }

        // C. Logic STORED PROCEDURE (Transaksi)
        function prosesStoredProcedure(e) {
            e.preventDefault();
            const user = document.getElementById('trx-user').value;
            const bukuId = parseInt(document.getElementById('trx-buku').value);
            const tglPinjam = document.getElementById('trx-date').value;

            const bukuIdx = dbBuku.findIndex(b => b.id === bukuId);
            
            // Validasi Stok
            if (dbBuku[bukuIdx].stok <= 0) {
                alert("Error: Stok buku habis!");
                return;
            }

            // --- STEP 1: INSERT Header & Detail (Simulasi) ---
            // Hitung tenggat (7 hari)
            let tgl = new Date(tglPinjam);
            tgl.setDate(tgl.getDate() + 7);
            let tglTenggat = tgl.toISOString().split('T')[0];

            let newTrx = {
                id: dbTransaksi.length + 1,
                peminjam: user,
                bukuId: bukuId,
                tglPinjam: tglPinjam,
                tglTenggat: tglTenggat,
                status: 'Dipinjam',
                denda: 0,
                keteranganDenda: '-'
            };
            dbTransaksi.push(newTrx);

            // --- STEP 2: UPDATE Stok (Simulasi Trigger/Proc) ---
            dbBuku[bukuIdx].stok -= 1;

            alert("STORED PROCEDURE Selesai:\n1. Insert Peminjaman OK\n2. Insert Detail OK\n3. Update Stok (-1) OK");
            
            renderAll();
            nav('laporan'); // Pindah ke tab laporan
        }

        // D. Logic UPDATE dengan CASE WHEN (Pengembalian)
        function kembalikanBuku(trxId) {
            let tglKembali = prompt("Masukkan Tanggal Kembali (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
            if(!tglKembali) return;

            const idx = dbTransaksi.findIndex(t => t.id === trxId);
            const trx = dbTransaksi[idx];

            // Hitung selisih hari
            const dateTenggat = new Date(trx.tglTenggat);
            const dateKembali = new Date(tglKembali);
            const diffTime = dateKembali - dateTenggat;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let denda = 0;
            if (diffDays > 0) denda = diffDays * 50000; // Misal denda 50rb/hari biar cepet tembus "Berat"

            // --- IMPLEMENTASI LOGIKA CASE WHEN SQL ---
            let labelStatus = '';
            // SQL Logic:
            // WHEN total_denda > 50000 THEN 'Pelanggaran Berat'
            // WHEN total_denda > 0 THEN 'Pelanggaran Ringan'
            // ELSE 'Bebas Denda'
            
            if (denda > 50000) {
                labelStatus = 'Pelanggaran Berat';
            } else if (denda > 0) {
                labelStatus = 'Pelanggaran Ringan';
            } else {
                labelStatus = 'Bebas Denda';
            }

            // Update DB
            dbTransaksi[idx].denda = denda;
            dbTransaksi[idx].status = 'Dikembalikan';
            dbTransaksi[idx].keteranganDenda = labelStatus;

            // Kembalikan Stok
            const bukuIdx = dbBuku.findIndex(b => b.id === trx.bukuId);
            dbBuku[bukuIdx].stok += 1;

            renderAll();
        }

        // --- 3. RENDER FUNCTION (VIEW) ---

        function renderAll() {
            // 1. Render Table Buku
            const tbodyBuku = document.getElementById('table-buku');
            const selectBuku = document.getElementById('trx-buku');
            tbodyBuku.innerHTML = '';
            selectBuku.innerHTML = '';

            let totalStok = 0;
            let kategoriCount = {}; // Untuk Aggregate

            dbBuku.forEach(b => {
                // Populate Table
                tbodyBuku.innerHTML += `<tr>
                    <td>${b.id}</td><td>${b.judul}</td><td>${b.kategori}</td><td>${b.stok}</td>
                </tr>`;

                // Populate Dropdown (Only available stock)
                if(b.stok > 0) {
                    selectBuku.innerHTML += `<option value="${b.id}">${b.judul} (Sisa: ${b.stok})</option>`;
                }

                // Hitung Aggregate
                totalStok += b.stok;
                if(kategoriCount[b.kategori]) kategoriCount[b.kategori]++;
                else kategoriCount[b.kategori] = 1;
            });

            // 2. Render Aggregate Dashboard
            document.getElementById('dash-total-buku').innerText = dbBuku.length;
            document.getElementById('dash-total-stok').innerText = totalStok;

            const tbodyAgg = document.getElementById('table-aggregate');
            tbodyAgg.innerHTML = '';
            for (let [kat, count] of Object.entries(kategoriCount)) {
                let percent = ((count / dbBuku.length) * 100).toFixed(0);
                tbodyAgg.innerHTML += `<tr>
                    <td>${kat}</td><td>${count} Judul</td>
                    <td><div style="background:#eee; width:100%; height:8px; border-radius:4px;"><div style="background:var(--accent); width:${percent}%; height:100%; border-radius:4px;"></div></div></td>
                </tr>`;
            }

            // 3. Render Laporan & Join
            const tbodyLap = document.getElementById('table-laporan');
            tbodyLap.innerHTML = '';
            let totalDendaUang = 0;

            dbTransaksi.forEach(trx => {
                // JOIN Logic (Ambil judul buku dari tabel buku berdasarkan ID)
                const bukuInfo = dbBuku.find(b => b.id === trx.bukuId);
                
                let badgeClass = 'bg-success';
                if(trx.keteranganDenda.includes('Berat')) badgeClass = 'bg-danger';
                if(trx.keteranganDenda.includes('Ringan')) badgeClass = 'bg-warning';

                let statusHTML = trx.status === 'Dipinjam' 
                    ? '<span class="badge bg-dark">Sedang Dipinjam</span>' 
                    : `<span class="badge ${badgeClass}">${trx.keteranganDenda}</span><br><small>Denda: Rp ${trx.denda.toLocaleString()}</small>`;

                let aksiBtn = trx.status === 'Dipinjam'
                    ? `<button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem;" onclick="kembalikanBuku(${trx.id})">Kembalikan</button>`
                    : '-';

                tbodyLap.innerHTML += `<tr>
                    <td>#TRX-${trx.id}</td>
                    <td>${trx.peminjam}</td>
                    <td>${bukuInfo.judul} <br><small style="color:#888">${bukuInfo.kategori}</small></td>
                    <td>${trx.tglPinjam}</td>
                    <td>${trx.tglTenggat}</td>
                    <td>${statusHTML}</td>
                    <td>${aksiBtn}</td>
                </tr>`;

                totalDendaUang += trx.denda;
            });

            document.getElementById('dash-total-denda').innerText = "Rp " + totalDendaUang.toLocaleString();
        }

        // Init
        document.getElementById('trx-date').valueAsDate = new Date();
        renderAll();

    </script>
</body>
</html>
