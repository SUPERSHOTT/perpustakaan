<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perpustakaan Final V3 (Fix Logic)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f6f7;
            --text: #333;
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); }
        
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { margin-bottom: 30px; font-size: 1.4rem; border-bottom: 1px solid #ffffff30; padding-bottom: 10px; }
        .nav-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--accent); }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card h3 { font-size: 2rem; color: var(--accent); margin-bottom: 5px; }
        .card p { color: #7f8c8d; font-size: 0.9rem; }

        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: var(--primary); }
        
        .form-box { background: white; padding: 25px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid var(--accent); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; color: white; display: inline-block; margin-right: 5px; }
        .btn-primary { background: var(--accent); }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; color: white; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: white; display: inline-block; }
        .bg-success { background: #2ecc71; }
        .bg-warning { background: #f1c40f; color: #333; }
        .bg-danger { background: #e74c3c; }
        .bg-dark { background: #34495e; }
        .bg-info { background: #1abc9c; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Perpustakaan</h2>
        <div class="nav-item active" onclick="nav('dashboard')">Dashboard</div>
        <div class="nav-item" onclick="nav('anggota')">Manajemen Anggota</div>
        <div class="nav-item" onclick="nav('buku')">Manajemen Buku</div>
        <div class="nav-item" onclick="nav('transaksi')">Sirkulasi (Pinjam)</div>
        <div class="nav-item" onclick="nav('laporan')">Riwayat & Denda</div>
    </div>

    <div class="main">
        
        <section id="dashboard" class="section active">
            <h1>Dashboard Eksekutif</h1>
            <div class="card-grid">
                <div class="card">
                    <h3 id="dash-total-anggota">0</h3>
                    <p>Total Anggota</p>
                </div>
                <div class="card">
                    <h3 id="dash-total-buku">0</h3>
                    <p>Total Judul Buku</p>
                </div>
                <div class="card">
                    <h3 id="dash-total-denda">Rp 0</h3>
                    <p>Potensi Denda (SUM)</p>
                </div>
            </div>
            <div class="table-container">
                <h3>Statistik Koleksi (Group By Kategori)</h3>
                <table>
                    <thead><tr><th>Kategori</th><th>Jumlah Judul</th><th>Visualisasi</th></tr></thead>
                    <tbody id="table-aggregate"></tbody>
                </table>
            </div>
        </section>

        <section id="anggota" class="section">
            <h1>Manajemen Anggota</h1>
            <div class="form-box" style="border-left-color: #9b59b6;">
                <h3>Registrasi Anggota Baru</h3>
                <form onsubmit="simpanAnggota(event)">
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="anggota-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="anggota-role" class="form-control">
                            <option value="Mahasiswa">Mahasiswa</option>
                            <option value="Dosen">Dosen</option>
                            <option value="Umum">Umum</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="background-color: #9b59b6;">Simpan</button>
                </form>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>Nama</th><th>Status</th><th>Aksi</th></tr></thead>
                    <tbody id="table-anggota"></tbody>
                </table>
            </div>
        </section>

        <section id="buku" class="section">
            <h1>Manajemen Buku</h1>
            <div class="form-box">
                <h3 id="form-buku-title">Tambah Buku Baru</h3>
                <form onsubmit="simpanBuku(event)">
                    <input type="hidden" id="buku-id">
                    <div class="form-group">
                        <label>Judul Buku</label>
                        <input type="text" id="buku-judul" class="form-control" required>
                    </div>
                    <div style="display:flex; gap:15px;">
                        <div class="form-group" style="flex:1">
                            <label>Kategori</label>
                            <select id="buku-kategori" class="form-control">
                                <option>Teknologi</option>
                                <option>Sains</option>
                                <option>Fiksi</option>
                                <option>Sejarah</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>Stok</label>
                            <input type="number" id="buku-stok" class="form-control" min="1" required>
                        </div>
                    </div>
                    <button id="btn-buku-submit" class="btn btn-primary">Simpan Buku</button>
                    <button type="button" id="btn-buku-cancel" class="btn btn-danger" style="display:none;" onclick="resetFormBuku()">Batal</button>
                </form>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>Judul</th><th>Kategori</th><th>Stok</th><th>Aksi</th></tr></thead>
                    <tbody id="table-buku"></tbody>
                </table>
            </div>
        </section>

        <section id="transaksi" class="section">
            <h1>Sirkulasi Peminjaman</h1>
            <div class="form-box" style="border-left-color: #27ae60;">
                <h3>Form Peminjaman (Stored Proc Logic)</h3>
                <form onsubmit="prosesPinjam(event)">
                    <div class="form-group">
                        <label>Nama Peminjam</label>
                        <select id="trx-user" class="form-control"></select> 
                    </div>
                    <div class="form-group">
                        <label>Pilih Buku</label>
                        <select id="trx-buku" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Pinjam</label>
                        <input type="date" id="trx-date" class="form-control" required>
                    </div>
                    <button class="btn btn-success">Proses Transaksi</button>
                </form>
            </div>
        </section>

        <section id="laporan" class="section">
            <h1>Riwayat & Pengembalian</h1>
            <div class="table-container">
                <h3>Daftar Transaksi (Join & Case When Logic)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Peminjam</th>
                            <th>Buku</th>
                            <th>Tenggat</th>
                            <th>Status / Denda</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-laporan"></tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        let dbAnggota = [
            { id: 1, nama: "Andi Saputra", role: "Mahasiswa" },
            { id: 2, nama: "Budi Santoso", role: "Dosen" }
        ];

        let dbBuku = [
            { id: 1, judul: "Belajar SQL Dasar", kategori: "Teknologi", stok: 5 },
            { id: 2, judul: "Laskar Pelangi", kategori: "Fiksi", stok: 3 }
        ];

        let dbTransaksi = [];
        let editBukuId = null;

        function nav(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
            renderAll();
        }

        function simpanAnggota(e) {
            e.preventDefault();
            dbAnggota.push({
                id: dbAnggota.length + 1,
                nama: document.getElementById('anggota-nama').value,
                role: document.getElementById('anggota-role').value
            });
            alert("Anggota tersimpan!");
            e.target.reset();
            renderAll();
        }

        function hapusAnggota(id) {
            if(confirm("Hapus anggota ini?")) {
                dbAnggota = dbAnggota.filter(m => m.id !== id);
                renderAll();
            }
        }

        function simpanBuku(e) {
            e.preventDefault();
            const judul = document.getElementById('buku-judul').value.trim();
            const kategori = document.getElementById('buku-kategori').value;
            const stok = parseInt(document.getElementById('buku-stok').value);

            if (editBukuId) {
                // LOGIC EDIT
                const idx = dbBuku.findIndex(b => b.id === editBukuId);
                dbBuku[idx] = { id: editBukuId, judul, kategori, stok };
                alert("Data buku berhasil diupdate!");
                resetFormBuku();
            } else {
                // LOGIC INSERT (CEK DUPLIKAT DULU)
                const existingIndex = dbBuku.findIndex(b => b.judul.toLowerCase() === judul.toLowerCase());
                
                if (existingIndex !== -1) {
                    // Jika buku sudah ada, tambah stoknya saja
                    dbBuku[existingIndex].stok += stok;
                    alert(`Buku "${judul}" sudah ada. Stok berhasil ditambahkan (Total: ${dbBuku[existingIndex].stok})`);
                } else {
                    // Jika belum ada, buat baru
                    dbBuku.push({ id: dbBuku.length + 1, judul, kategori, stok });
                    alert("Buku baru berhasil ditambahkan!");
                }
                e.target.reset();
            }
            renderAll();
        }

        function editBuku(id) {
            const b = dbBuku.find(b => b.id === id);
            document.getElementById('buku-id').value = b.id;
            document.getElementById('buku-judul').value = b.judul;
            document.getElementById('buku-kategori').value = b.kategori;
            document.getElementById('buku-stok').value = b.stok;
            
            editBukuId = id;
            document.getElementById('form-buku-title').innerText = "Edit Buku ID: " + id;
            document.getElementById('btn-buku-submit').innerText = "Update";
            document.getElementById('btn-buku-cancel').style.display = "inline-block";
            document.getElementById('buku').scrollTop = 0;
        }

        function hapusBuku(id) {
            if(confirm("Yakin ingin menghapus buku ini dari database?")) {
                dbBuku = dbBuku.filter(b => b.id !== id);
                alert("Buku berhasil dihapus.");
                renderAll();
            }
        }

        function resetFormBuku() {
            editBukuId = null;
            document.getElementById('form-buku-title').innerText = "Tambah Buku Baru";
            document.getElementById('btn-buku-submit').innerText = "Simpan Buku";
            document.getElementById('btn-buku-cancel').style.display = "none";
            document.getElementById('buku-judul').value = "";
            document.getElementById('buku-stok').value = "";
        }

        function prosesPinjam(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('trx-user').value);
            const bukuId = parseInt(document.getElementById('trx-buku').value);
            const tglPinjam = document.getElementById('trx-date').value;

            if(!userId || !bukuId) { alert("Data tidak lengkap"); return; }

            const user = dbAnggota.find(u => u.id === userId);
            const bukuIdx = dbBuku.findIndex(b => b.id === bukuId);

            if(dbBuku[bukuIdx].stok <= 0) { alert("Stok Habis!"); return; }

            let tgl = new Date(tglPinjam);
            tgl.setDate(tgl.getDate() + 7);
            
            dbTransaksi.push({
                id: dbTransaksi.length + 1,
                userId: userId,
                userName: user.nama,
                bukuId: bukuId,
                tglPinjam: tglPinjam,
                tglTenggat: tgl.toISOString().split('T')[0],
                status: 'Dipinjam',
                denda: 0,
                ket: '-'
            });

            dbBuku[bukuIdx].stok -= 1;
            alert("Peminjaman Berhasil!");
            renderAll();
            nav('laporan');
        }

        function kembalikanBuku(trxId) {
            let tglKembali = prompt("Masukkan Tanggal Kembali (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
            if(!tglKembali) return;

            const idx = dbTransaksi.findIndex(t => t.id === trxId);
            const trx = dbTransaksi[idx];
            
            const diffDays = Math.ceil((new Date(tglKembali) - new Date(trx.tglTenggat)) / (1000 * 3600 * 24));
            let denda = diffDays > 0 ? diffDays * 50000 : 0;
            
            let statusKet = 'Bebas Denda';
            if (denda > 50000) statusKet = 'Pelanggaran Berat';
            else if (denda > 0) statusKet = 'Pelanggaran Ringan';

            dbTransaksi[idx].denda = denda;
            dbTransaksi[idx].status = 'Dikembalikan';
            dbTransaksi[idx].ket = statusKet;

            const bukuIdx = dbBuku.findIndex(b => b.id === trx.bukuId);
            dbBuku[bukuIdx].stok += 1;

            renderAll();
        }

        function renderAll() {
            const tbodyAnggota = document.getElementById('table-anggota');
            const selectUser = document.getElementById('trx-user');
            tbodyAnggota.innerHTML = '';
            selectUser.innerHTML = '';

            dbAnggota.forEach(m => {
                tbodyAnggota.innerHTML += `<tr>
                    <td>${m.id}</td><td>${m.nama}</td>
                    <td><span class="badge bg-info">${m.role}</span></td>
                    <td><button class="btn btn-danger" style="font-size:0.7rem" onclick="hapusAnggota(${m.id})">Hapus</button></td>
                </tr>`;
                selectUser.innerHTML += `<option value="${m.id}">${m.nama} (${m.role})</option>`;
            });

            const tbodyBuku = document.getElementById('table-buku');
            const selectBuku = document.getElementById('trx-buku');
            tbodyBuku.innerHTML = '';
            selectBuku.innerHTML = '';
            
            let totalStok = 0;
            let catCount = {};

            dbBuku.forEach(b => {
                tbodyBuku.innerHTML += `<tr>
                    <td>${b.id}</td><td>${b.judul}</td><td>${b.kategori}</td><td>${b.stok}</td>
                    <td>
                        <button class="btn btn-warning" style="font-size:0.7rem" onclick="editBuku(${b.id})">Edit</button>
                        <button class="btn btn-danger" style="font-size:0.7rem" onclick="hapusBuku(${b.id})">Hapus</button>
                    </td>
                </tr>`;
                if(b.stok > 0) selectBuku.innerHTML += `<option value="${b.id}">${b.judul}</option>`;
                
                totalStok += b.stok;
                catCount[b.kategori] = (catCount[b.kategori] || 0) + 1;
            });

            const tbodyLap = document.getElementById('table-laporan');
            tbodyLap.innerHTML = '';
            let totalDenda = 0;

            dbTransaksi.forEach(trx => {
                const buku = dbBuku.find(b => b.id === trx.bukuId);
                // Handle case if book deleted
                const judulBuku = buku ? buku.judul : "(Buku Dihapus)";

                let badge = trx.status === 'Dipinjam' ? 'bg-dark' : (trx.ket.includes('Berat') ? 'bg-danger' : 'bg-success');
                let statusText = trx.status === 'Dipinjam' ? 'Sedang Dipinjam' : `${trx.ket}<br>Denda: ${trx.denda.toLocaleString()}`;
                let btn = trx.status === 'Dipinjam' ? `<button class="btn btn-primary" onclick="kembalikanBuku(${trx.id})">Kembali</button>` : '-';

                tbodyLap.innerHTML += `<tr>
                    <td>TRX-${trx.id}</td><td>${trx.userName}</td><td>${judulBuku}</td><td>${trx.tglTenggat}</td>
                    <td><span class="badge ${badge}">${statusText}</span></td><td>${btn}</td>
                </tr>`;
                totalDenda += trx.denda;
            });

            document.getElementById('dash-total-anggota').innerText = dbAnggota.length;
            document.getElementById('dash-total-buku').innerText = dbBuku.length;
            document.getElementById('dash-total-denda').innerText = "Rp " + totalDenda.toLocaleString();

            const tbodyAgg = document.getElementById('table-aggregate');
            tbodyAgg.innerHTML = '';
            for(let c in catCount) {
                let w = (catCount[c]/dbBuku.length)*100;
                tbodyAgg.innerHTML += `<tr><td>${c}</td><td>${catCount[c]}</td><td><div style="background:#ddd;height:5px"><div style="background:var(--accent);width:${w}%;height:5px"></div></div></td></tr>`;
            }
        }

        document.getElementById('trx-date').valueAsDate = new Date();
        renderAll();
    </script>
</body>
</html>
