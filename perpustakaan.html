<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Perpustakaan V2</title>
    <style>
        /* --- CSS STYLING (Sama seperti sebelumnya dengan tambahan badge) --- */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --text-light: #ecf0f1;
            --bg-light: #f4f7f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-light); }

        /* Sidebar */
        .sidebar { width: 250px; background-color: var(--primary-color); color: var(--text-light); display: flex; flex-direction: column; padding: 20px; }
        .sidebar h2 { margin-bottom: 30px; font-size: 1.5rem; text-align: center; border-bottom: 1px solid #ffffff30; padding-bottom: 10px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 5px; transition: 0.3s; margin-bottom: 5px; }
        .menu-item:hover, .menu-item.active { background-color: var(--accent-color); }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        h1 { margin-bottom: 20px; color: var(--primary-color); }

        /* Dashboard Cards */
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { font-size: 2rem; color: var(--accent-color); margin-bottom: 5px; }
        
        /* Tables & Forms */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9rem; }
        th { background-color: var(--secondary-color); color: white; }
        
        .form-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid var(--accent-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 15px; }
        .form-group { margin-bottom: 15px; flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Buttons */
        .btn { padding: 8px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background-color: var(--accent-color); }
        .btn-warning { background-color: var(--warning-color); } /* Edit Button */
        .btn-danger { background-color: var(--danger-color); } /* Cancel/Return Button */
        .btn-success { background-color: var(--success-color); }
        
        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: white; }
        .bg-green { background-color: var(--success-color); }
        .bg-red { background-color: var(--danger-color); }
        .bg-orange { background-color: var(--warning-color); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>Perpustakaan V2</h2>
        <div class="menu-item active" onclick="showSection('dashboard')">Dashboard</div>
        <div class="menu-item" onclick="showSection('anggota')">Data Anggota</div> <div class="menu-item" onclick="showSection('buku')">Data Buku</div>
        <div class="menu-item" onclick="showSection('peminjaman')">Sirkulasi & Denda</div>
    </nav>

    <main class="main-content">
        
        <section id="dashboard" class="section active">
            <h1>Dashboard Overview</h1>
            <div class="dashboard-cards">
                <div class="card">
                    <h3 id="stat-buku">0</h3>
                    <p>Total Buku</p>
                </div>
                <div class="card">
                    <h3 id="stat-anggota">0</h3>
                    <p>Total Anggota</p>
                </div>
                <div class="card">
                    <h3 id="stat-pinjam">0</h3>
                    <p>Sedang Dipinjam</p>
                </div>
                <div class="card">
                    <h3 id="stat-denda" style="color: var(--danger-color);">Rp 0</h3>
                    <p>Total Denda Masuk</p>
                </div>
            </div>
        </section>

        <section id="anggota" class="section">
            <h1>Manajemen Anggota</h1>
            <div class="form-container">
                <h3>Tambah Anggota Baru</h3>
                <form onsubmit="tambahAnggota(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Depan</label>
                            <input type="text" id="member-depan" required>
                        </div>
                        <div class="form-group">
                            <label>Nama Belakang</label>
                            <input type="text" id="member-belakang" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="member-email" required>
                        </div>
                        <div class="form-group">
                            <label>No HP</label>
                            <input type="text" id="member-hp" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Simpan Anggota</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama Lengkap</th>
                        <th>Email</th>
                        <th>No HP</th>
                    </tr>
                </thead>
                <tbody id="tabel-anggota-body"></tbody>
            </table>
        </section>

        <section id="buku" class="section">
            <h1>Manajemen Buku</h1>
            
            <div class="form-container">
                <h3 id="form-buku-title">Tambah Buku Baru</h3>
                <form id="formBuku" onsubmit="simpanBuku(event)">
                    <input type="hidden" id="buku-id"> <div class="form-group">
                        <label>Judul Buku</label>
                        <input type="text" id="judul" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Penulis</label>
                            <input type="text" id="penulis" required>
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="kategori">
                                <option value="Teknologi">Teknologi</option>
                                <option value="Fiksi">Fiksi</option>
                                <option value="Sains">Sains</option>
                                <option value="Sejarah">Sejarah</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Stok</label>
                        <input type="number" id="stok" required min="1">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="btn-save-buku">Simpan</button>
                    <button type="button" class="btn btn-danger" id="btn-cancel-buku" style="display:none;" onclick="resetFormBuku()">Batal Edit</button>
                </form>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Judul</th>
                        <th>Penulis</th>
                        <th>Kategori</th>
                        <th>Stok</th>
                        <th>Aksi</th> </tr>
                </thead>
                <tbody id="tabel-buku-body"></tbody>
            </table>
        </section>

        <section id="peminjaman" class="section">
            <h1>Sirkulasi & Pengembalian</h1>

            <div class="form-container">
                <h3>Catat Peminjaman</h3>
                <form onsubmit="prosesPinjam(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pilih Anggota</label>
                            <select id="pinjam-member"></select> </div>
                        <div class="form-group">
                            <label>Pilih Buku</label>
                            <select id="pinjam-buku"></select> </div>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Pinjam</label>
                        <input type="date" id="tgl-pinjam" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Proses Peminjaman</button>
                </form>
            </div>

            <h3>Daftar Transaksi Aktif & Riwayat</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Peminjam</th>
                        <th>Buku</th>
                        <th>Tgl Pinjam</th>
                        <th>Tenggat</th>
                        <th>Status / Denda</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabel-pinjam-body"></tbody>
            </table>
        </section>

    </main>

    <script>
        /* --- JAVASCRIPT LOGIC --- */

        // 1. DATABASE SEMENTARA (Array)
        let dataBuku = [
            { id: 1, judul: "Algoritma Pemrograman", penulis: "Rinaldi Munir", kategori: "Teknologi", stok: 5 },
            { id: 2, judul: "Laskar Pelangi", penulis: "Andrea Hirata", kategori: "Fiksi", stok: 3 }
        ];

        let dataMember = [
            { id: 1, namaDepan: "Andi", namaBelakang: "Saputra", email: "andi@mail.com", hp: "08123456" },
            { id: 2, namaDepan: "Budi", namaBelakang: "Santoso", email: "budi@mail.com", hp: "08987654" }
        ];

        let dataTransaksi = []; // { id, memberId, bukuId, tglPinjam, tglKembaliRencana, tglKembaliAsli, denda, status }

        // Config Denda
        const DENDA_PER_HARI = 1000; 

        // 2. NAVIGASI
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Highlight Menu
            const menus = document.querySelectorAll('.menu-item');
            if(id=='dashboard') menus[0].classList.add('active');
            if(id=='anggota') menus[1].classList.add('active');
            if(id=='buku') menus[2].classList.add('active');
            if(id=='peminjaman') menus[3].classList.add('active');
            
            updateUI();
        }

        // 3. LOGIC ANGGOTA (ADD & LIST)
        function tambahAnggota(e) {
            e.preventDefault();
            dataMember.push({
                id: dataMember.length + 1,
                namaDepan: document.getElementById('member-depan').value,
                namaBelakang: document.getElementById('member-belakang').value,
                email: document.getElementById('member-email').value,
                hp: document.getElementById('member-hp').value
            });
            alert("Anggota berhasil ditambahkan!");
            e.target.reset();
            updateUI();
        }

        function renderAnggota() {
            const tbody = document.getElementById('tabel-anggota-body');
            const selectMember = document.getElementById('pinjam-member');
            tbody.innerHTML = '';
            selectMember.innerHTML = '';

            dataMember.forEach(m => {
                // Table
                tbody.innerHTML += `<tr>
                    <td>${m.id}</td>
                    <td>${m.namaDepan} ${m.namaBelakang}</td>
                    <td>${m.email}</td>
                    <td>${m.hp}</td>
                </tr>`;
                
                // Dropdown Peminjaman
                selectMember.innerHTML += `<option value="${m.id}">${m.namaDepan} ${m.namaBelakang}</option>`;
            });
        }

        // 4. LOGIC BUKU (ADD & EDIT)
        let editModeId = null; // Menyimpan ID buku yang sedang diedit

        function simpanBuku(e) {
            e.preventDefault();
            const judul = document.getElementById('judul').value;
            const penulis = document.getElementById('penulis').value;
            const kategori = document.getElementById('kategori').value;
            const stok = parseInt(document.getElementById('stok').value);

            if (editModeId) {
                // UPDATE (EDIT)
                const index = dataBuku.findIndex(b => b.id === editModeId);
                dataBuku[index] = { id: editModeId, judul, penulis, kategori, stok };
                alert("Data buku berhasil diperbarui!");
                resetFormBuku();
            } else {
                // INSERT (NEW)
                dataBuku.push({ id: dataBuku.length + 1, judul, penulis, kategori, stok });
                alert("Buku baru berhasil ditambahkan!");
                e.target.reset();
            }
            updateUI();
        }

        function editBuku(id) {
            const buku = dataBuku.find(b => b.id === id);
            if(buku) {
                document.getElementById('buku-id').value = buku.id;
                document.getElementById('judul').value = buku.judul;
                document.getElementById('penulis').value = buku.penulis;
                document.getElementById('kategori').value = buku.kategori;
                document.getElementById('stok').value = buku.stok;

                // UI Changes
                editModeId = id;
                document.getElementById('form-buku-title').innerText = "Edit Buku ID: " + id;
                document.getElementById('btn-save-buku').innerText = "Update Data";
                document.getElementById('btn-cancel-buku').style.display = "inline-block";
                
                // Scroll to top
                document.getElementById('buku').scrollTop = 0;
            }
        }

        function resetFormBuku() {
            editModeId = null;
            document.getElementById('formBuku').reset();
            document.getElementById('form-buku-title').innerText = "Tambah Buku Baru";
            document.getElementById('btn-save-buku').innerText = "Simpan";
            document.getElementById('btn-cancel-buku').style.display = "none";
        }

        function renderBuku() {
            const tbody = document.getElementById('tabel-buku-body');
            const selectBuku = document.getElementById('pinjam-buku');
            tbody.innerHTML = '';
            selectBuku.innerHTML = '';

            dataBuku.forEach(b => {
                // Table
                tbody.innerHTML += `<tr>
                    <td>${b.id}</td>
                    <td>${b.judul}</td>
                    <td>${b.penulis}</td>
                    <td>${b.kategori}</td>
                    <td>${b.stok}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editBuku(${b.id})">Edit</button>
                    </td>
                </tr>`;

                // Dropdown Peminjaman (Cuma kalau stok > 0)
                if(b.stok > 0) {
                    selectBuku.innerHTML += `<option value="${b.id}">${b.judul} (Stok: ${b.stok})</option>`;
                }
            });
        }

        // 5. LOGIC PEMINJAMAN & DENDA
        function prosesPinjam(e) {
            e.preventDefault();
            const memberId = parseInt(document.getElementById('pinjam-member').value);
            const bukuId = parseInt(document.getElementById('pinjam-buku').value);
            const tglPinjam = document.getElementById('tgl-pinjam').value;

            if(!bukuId || !memberId) { alert("Data tidak lengkap!"); return; }

            // Kurangi Stok
            const bukuIndex = dataBuku.findIndex(b => b.id === bukuId);
            dataBuku[bukuIndex].stok -= 1;

            // Hitung Tenggat (7 Hari)
            let tgl = new Date(tglPinjam);
            tgl.setDate(tgl.getDate() + 7);
            const tglTenggat = tgl.toISOString().split('T')[0];

            dataTransaksi.push({
                id: dataTransaksi.length + 1,
                memberId: memberId,
                bukuId: bukuId,
                tglPinjam: tglPinjam,
                tglKembaliRencana: tglTenggat,
                tglKembaliAsli: null, // Belum kembali
                denda: 0,
                status: 'Dipinjam'
            });

            alert("Peminjaman sukses!");
            updateUI();
        }

        function kembalikanBuku(trxId) {
            // Prompt tanggal kembali
            let tglKembali = prompt("Masukkan tanggal pengembalian (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
            
            if (tglKembali) {
                const trxIndex = dataTransaksi.findIndex(t => t.id === trxId);
                const trx = dataTransaksi[trxIndex];

                // Hitung Denda
                const dateRencana = new Date(trx.tglKembaliRencana);
                const dateAsli = new Date(tglKembali);
                
                // Selisih waktu dalam milidetik
                const diffTime = dateAsli - dateRencana;
                // Ubah ke hari (jika negatif = tidak telat)
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                let denda = 0;
                let status = "Selesai";

                if (diffDays > 0) {
                    denda = diffDays * DENDA_PER_HARI;
                    status = "Terlambat (" + diffDays + " hari)";
                    alert(`Buku terlambat ${diffDays} hari.\nDenda: Rp ${denda.toLocaleString()}`);
                } else {
                    alert("Buku kembali tepat waktu. Tidak ada denda.");
                }

                // Update Transaksi
                dataTransaksi[trxIndex].tglKembaliAsli = tglKembali;
                dataTransaksi[trxIndex].denda = denda;
                dataTransaksi[trxIndex].status = status;

                // Kembalikan Stok Buku
                const bukuIndex = dataBuku.findIndex(b => b.id === trx.bukuId);
                dataBuku[bukuIndex].stok += 1;

                updateUI();
            }
        }

        function renderTransaksi() {
            const tbody = document.getElementById('tabel-pinjam-body');
            tbody.innerHTML = '';
            let totalDenda = 0;
            let countPinjam = 0;

            // Sortir biar yang terbaru di atas
            const sortedTrx = [...dataTransaksi].sort((a,b) => b.id - a.id);

            sortedTrx.forEach(trx => {
                const member = dataMember.find(m => m.id === trx.memberId);
                const buku = dataBuku.find(b => b.id === trx.bukuId);
                
                // Hitung Statistik
                if(trx.status === 'Dipinjam') countPinjam++;
                totalDenda += trx.denda;

                // Tombol Aksi (Jika status dipinjam, muncul tombol Kembali)
                let aksiButton = '';
                if(trx.status === 'Dipinjam') {
                    aksiButton = `<button class="btn btn-success" onclick="kembalikanBuku(${trx.id})">Kembalikan</button>`;
                } else {
                    aksiButton = `<span class="badge bg-green">Selesai</span>`;
                }

                // Warna Status
                let statusColor = trx.denda > 0 ? 'color:red; font-weight:bold;' : 'color:green;';
                let displayStatus = trx.status === 'Dipinjam' 
                    ? '<span class="badge bg-orange">Sedang Dipinjam</span>' 
                    : `<span style="${statusColor}">${trx.status}</span>`;

                if(trx.denda > 0) displayStatus += `<br><small>Denda: Rp ${trx.denda}</small>`;

                tbody.innerHTML += `<tr>
                    <td>TRX-${trx.id}</td>
                    <td>${member.namaDepan}</td>
                    <td>${buku.judul}</td>
                    <td>${trx.tglPinjam}</td>
                    <td>${trx.tglKembaliRencana}</td>
                    <td>${displayStatus}</td>
                    <td>${aksiButton}</td>
                </tr>`;
            });

            // Update Dashboard Stats
            document.getElementById('stat-buku').innerText = dataBuku.length;
            document.getElementById('stat-anggota').innerText = dataMember.length;
            document.getElementById('stat-pinjam').innerText = countPinjam;
            document.getElementById('stat-denda').innerText = "Rp " + totalDenda.toLocaleString();
        }

        // MASTER UPDATE UI
        function updateUI() {
            renderAnggota();
            renderBuku();
            renderTransaksi();
        }

        // Init Date
        document.getElementById('tgl-pinjam').valueAsDate = new Date();
        updateUI();

    </script>
</body>
</html>